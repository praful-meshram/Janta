/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.42
 * Generated at: 2014-03-14 08:16:58 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import java.sql.*;
import javax.naming.*;
import javax.sql.*;
import java.io.*;

public final class RDeliveryCloseOrders_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private javax.el.ExpressionFactory _el_expressionfactory;
  private org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public void _jspInit() {
    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\n");
      out.write("\n");
      out.write("\n");
      out.write("\n");
      org.apache.jasper.runtime.JspRuntimeLibrary.include(request, response, "sessionBoth.jsp?formName=RDeliveryCloseOrders.jsp", out, false);
      out.write('\n');

		String str1="",pageName="",del_date="";
		String dateArray[]=null;
		int success=0;
		pageName=request.getParameter("page");		    		    
		del_date=request.getParameter("hiddatearray");
		System.out.println("Hidden Array of Date = "+request.getParameter("hiddatearray"));
 		dateArray=del_date.split(",");    
		String query="",updSql="";
		Connection conn=null,conn11=null, conn1=null;
		Statement stat=null,stmt=null, stat1=null,stat11=null;
		ResultSet rs=null,rs1=null,rs11=null;	
		String closedate="";
		String userstr = session.getAttribute("UserName").toString();
				   
		try{	
			Context initContext = new InitialContext();
			Context envContext  = (Context)initContext.lookup("java:/comp/env");
			//DataSource ds = (DataSource)envContext.lookup("jdbc/js");
			DataSource ds = (DataSource)envContext.lookup("jdbc/re");
			conn = ds.getConnection();
			stat=conn.createStatement();
			stmt=conn.createStatement();
			query="select now()";				 	   							 	   
			rs=stat.executeQuery(query);
			while(rs.next()){
			    closedate = rs.getString(1);
			}
 			for(int i=0; i<dateArray.length; i++){
				if(!dateArray[i].equals("")){
					 query="select order_num, custcode,payment_type_code from orders "+
					 	   "where trim(Date(del_datetime))='"+dateArray[i]+"'";
					 System.out.println("select order  "+query);
				 	   rs=stat.executeQuery(query);
				 	   while(rs.next()){
				 	   		updSql="update orders set status_code='CLOSED',lastmodifieddate='"+closedate+"', closed_datetime='"+closedate+"' ,close_status='BULK_"+dateArray[i]+"'"+
				 	   		" where order_num='"+rs.getString(1)+"'";
				 	   		System.out.println("updSql="+updSql);
							int a=stmt.executeUpdate(updSql);
							//System.out.println("value of a="+a);
							success=1;																 	   					 	   				 	   				 	   					 	   					 	   				 	   
				 	   }
	 	 
 				 }
 			}//EOF for			
			
			int secans=0;
			if(success==1){
				String order_num="", custcode="", order_date="", payment_type_code="",total_value="",paid_amt="",balance_amt="";
					
				for(int i=0; i<dateArray.length; i++){
					if(!dateArray[i].equals("")){					
						 query="select order_num, custcode, order_date, payment_type_code,total_value,paid_amt,balance_amt from orders "+
						 	   "where trim(Date(del_datetime))='"+dateArray[i]+"'";				 	   							 	   
					 	    System.out.println(query);
					 	   rs=stat.executeQuery(query);
					 	  
					 	   while(rs.next()){
					 	   		order_num=rs.getString(1);
					 	   		custcode=rs.getString(2);
					 	   		order_date = rs.getString(3);
					 	   		payment_type_code = rs.getString(4);
					 	   		total_value = rs.getString(5);
					 	   		paid_amt  = rs.getString(6);
					 	   		balance_amt = rs.getString(7);
					 	   		
					 	   		/*DataSource ds1 = (DataSource)envContext.lookup("jdbc/js_rec");
								conn1 = ds1.getConnection();
								stat1=conn1.createStatement();
								String query11 ="replace into order_recovery(order_num, custcode, order_date, payment_type_code, closed_datetime, close_status, total_value, paid_amt, balance_amt, lastmodifieddate, lastmodifiedby) "+
											" values('"+order_num+"', '"+custcode+"','"+order_date+"', '"+payment_type_code+"','"+closedate+"','BULK_"+dateArray[i]+"','"+total_value+"','"+paid_amt+"','"+balance_amt+"','"+closedate+"','"+userstr+"')";				 	   							 	   
								 System.out.println(query11);
								secans = stat1.executeUpdate(query11);	
								conn1.close();*/
					 	   	secans=1;
							}
		 	 		 }
 				}//EOF for	 				
 			}
			
			conn.close();
 			System.out.println("connection close after close order ");
 			if(secans ==1){

      out.write("\n");
      out.write("\t\t\t\t");
      if (true) {
        _jspx_page_context.forward("RDeliveryDailyReportSummary.jsp?Exp=0&closeresult=1");
        return;
      }
      out.write('	');
      out.write('\n');
					
			success=0;
			}			
			else{

      out.write('\n');
      out.write('	');
      out.write('	');
      if (true) {
        _jspx_page_context.forward("RDeliveryDailyReportSummary.jsp?Exp=0&closeresult=0");
        return;
      }
      out.write('	');
      out.write('\n');
				
			}
 			
 		} 	
 	catch(Exception e){
	 	success=0;
	 	System.out.println("Exception occured....");
	 	e.printStackTrace();
 	}
 	

      out.write(' ');
      out.write('\n');
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try { out.clearBuffer(); } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
